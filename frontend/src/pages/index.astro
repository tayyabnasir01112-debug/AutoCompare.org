---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import FormattedDate from '../components/FormattedDate.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog')).sort(
        (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
).slice(0, 3);

let priceData = {};
try {
        const fs = await import('fs/promises');
        const path = await import('path');
        const { fileURLToPath } = await import('url');
        
        // Calculate path relative to this file's location
        // This file is in: frontend/src/pages/index.astro
        // Public folder is at: frontend/public/
        const currentFile = fileURLToPath(import.meta.url);
        const pagesDir = path.dirname(currentFile);
        const srcDir = path.dirname(pagesDir);
        const frontendDir = path.dirname(srcDir);
        const pricesPath = path.join(frontendDir, 'public', 'data', 'prices.json');
        
        const fileContent = await fs.readFile(pricesPath, 'utf-8');
        priceData = JSON.parse(fileContent);
} catch (error) {
        // Price data not available - this is OK for initial setup
        console.log('Price data not available yet (this is normal on first run):', error.message);
}

const priceItems = Object.entries(priceData);
---

<!doctype html>
<html lang="en">
        <head>
                <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
                <style>
                        .price-grid {
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                                gap: 2rem;
                                margin: 2rem 0;
                        }
                        .price-card {
                                background: #f8f9fa;
                                border-radius: 8px;
                                padding: 1.5rem;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                transition: transform 0.2s, box-shadow 0.2s;
                        }
                        .price-card:hover {
                                transform: translateY(-4px);
                                box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                        }
                        .price-card h3 {
                                margin: 0 0 1rem 0;
                                font-size: 1.25rem;
                                color: #333;
                        }
                        .price {
                                font-size: 2rem;
                                font-weight: bold;
                                color: #0066cc;
                                margin: 0.5rem 0;
                        }
                        .description {
                                color: #666;
                                font-size: 0.95rem;
                                margin: 0.5rem 0;
                        }
                        .meta {
                                font-size: 0.85rem;
                                color: #999;
                                margin-top: 1rem;
                        }
                        .status {
                                display: inline-block;
                                padding: 0.25rem 0.5rem;
                                border-radius: 4px;
                                font-size: 0.85rem;
                                margin-top: 0.5rem;
                        }
                        .status.success {
                                background: #d4edda;
                                color: #155724;
                        }
                        .status.error {
                                background: #f8d7da;
                                color: #721c24;
                        }
                        .blog-section {
                                margin-top: 3rem;
                                padding-top: 2rem;
                                border-top: 2px solid #e9ecef;
                        }
                        .blog-grid {
                                display: grid;
                                gap: 1.5rem;
                                margin: 2rem 0;
                        }
                        .blog-card {
                                border-left: 3px solid #0066cc;
                                padding-left: 1rem;
                        }
                        .blog-card h4 {
                                margin: 0 0 0.5rem 0;
                        }
                        .blog-card a {
                                color: #0066cc;
                                text-decoration: none;
                                font-weight: 600;
                        }
                        .blog-card a:hover {
                                text-decoration: underline;
                        }
                        .hero {
                                text-align: center;
                                padding: 2rem 0;
                                margin-bottom: 2rem;
                        }
                        .hero h1 {
                                font-size: 2.5rem;
                                margin-bottom: 1rem;
                                color: #1a1a1a;
                        }
                        .hero p {
                                font-size: 1.2rem;
                                color: #666;
                        }
                </style>
        </head>
        <body>
                <Header />
                <main>
                        <div class="hero">
                                <h1>Welcome to AutoCompare</h1>
                                <p>Your automated price comparison and shopping guide</p>
                        </div>

                        <section>
                                <h2>Latest Price Comparisons</h2>
                                {priceItems.length > 0 ? (
                                        <div class="price-grid">
                                                {priceItems.map(([key, item]) => (
                                                        <div class="price-card">
                                                                <h3>{item.data?.title || 'Product'}</h3>
                                                                <div class="price">{item.data?.price || 'N/A'}</div>
                                                                <p class="description">{item.data?.description || 'No description available'}</p>
                                                                <div class="meta">
                                                                        <div>Source: {item.site}</div>
                                                                        <div>Last updated: {new Date(item.scraped_at).toLocaleString()}</div>
                                                                </div>
                                                                <span class={`status ${item.success ? 'success' : 'error'}`}>
                                                                        {item.success ? 'Available' : 'Unavailable'}
                                                                </span>
                                                        </div>
                                                ))}
                                        </div>
                                ) : (
                                        <p>No price data available yet. Run the scraper to populate prices.</p>
                                )}
                        </section>

                        <section class="blog-section">
                                <h2>Latest Shopping Guides</h2>
                                <div class="blog-grid">
                                        {posts.map((post) => (
                                                <article class="blog-card">
                                                        <h4>
                                                                <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
                                                        </h4>
                                                        <FormattedDate date={post.data.pubDate} />
                                                        {post.data.description && <p>{post.data.description}</p>}
                                                </article>
                                        ))}
                                </div>
                                <a href="/blog" style="color: #0066cc; font-weight: 600;">View all blog posts â†’</a>
                        </section>
                </main>
                <Footer />
        </body>
</html>
